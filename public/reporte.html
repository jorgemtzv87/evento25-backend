<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Vendedor</title>
    <style>
        /* Estilos generales */
        body { font-family: Arial, sans-serif; background: #f0f2f5; display: grid; place-items: center; padding-top: 20px; margin: 0; padding-top: 80px; }
        .main-nav { width: 100%; background-color: #333; padding: 15px 0; position: fixed; top: 0; left: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .main-nav ul { display: flex; justify-content: center; list-style: none; margin: 0; padding: 0; }
        .main-nav li { margin: 0 10px; }
        .main-nav a { color: white; text-decoration: none; font-weight: bold; font-size: 0.9em; padding: 8px 12px; border-radius: 4px; transition: background-color 0.3s; }
        .main-nav a:hover { background-color: #555; }
        .main-nav a.active { background-color: #007bff; }
        
        /* Contenedor del formulario */
        #form-container { width: 450px; padding: 30px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 20px; }
        h2 { text-align: center; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 10px; font-size: 1.1em; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button[type="submit"] { width: 100%; padding: 12px; font-size: 1.1em; background-color: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; }
        
        /* Botón Pagar */
        #pagarComisionBtn { width: 100%; padding: 12px; font-size: 1.1em; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 15px; display: none; }
        
        /* Mensajes */
        #mensaje { margin-top: 20px; text-align: center; font-size: 1.1em; }
        .exito { color: green; } .error { color: red; }
        
        /* Reporte */
        #reporte-container { display: none; border-top: 2px solid #eee; margin-top: 25px; padding-top: 20px; }
        #reporte-container h3 { text-align: center; margin-top: 0; color: #007bff; }
        .reporte-linea { display: flex; justify-content: space-between; font-size: 1.2em; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .reporte-linea span { font-weight: bold; }
        .comision-desglose { background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; }
        .total-comision { font-size: 1.5em; font-weight: bold; color: #28a745; text-align: center; margin-top: 20px; padding-top: 15px; border-top: 2px solid #000; }
        
        /* CSS del Modal ELIMINADO */
        
        /* CSS Botón NFC */
        .uid-container { position: relative; }
        #scanNFC {
            position: absolute;
            top: 29px; 
            right: 5px;
            padding: 5px 8px;
            font-size: 0.8em;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
        }
    </style>
</head>
<body>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html">Registrar Vendedor</a></li>
            <li><a href="asignar.html">Asignar Pizzas</a></li>
            <li><a href="vender.html">Registrar Venta</a></li>
            <li><a href="reporte.html" class="active">Ver Reporte</a></li>
            <li><a href="devolver.html">Registrar Devolución</a></li>
        </ul>
    </nav>

    <div id="form-container">
        <h2>Reporte de Vendedor</h2>
        <form id="reporteForm">
             <div class="form-group uid-container">
                <label for="uid">Escanear Tarjeta del Vendedor</label>
                <input type="text" id="uid" name="uid" required autofocus>
                <button type="button" id="scanNFC">Escanear NFC</button>
            </div>
            <button type="submit">Generar Reporte</button>
        </form>
        <div id="mensaje"></div>
        <div id="reporte-container">
            <h3 id="reporte-nombre"></h3>
            <div class="reporte-linea">Pizzas Asignadas: <span id="reporte-pizzas">0</span></div>
            <div class="reporte-linea">Pizzas Vendidas: <span id="reporte-vendidas" style="color: #007bff;">0</span></div>
            <div class="reporte-linea">Dinero ya Pagado: <span id="reporte-pagado" style="color: green;">$0.00</span></div>
            <div class="reporte-linea">Dinero Pendiente (Debe): <span id="reporte-pendiente" style="color: red;">$0.00</span></div>
            <div class="comision-desglose">
                <div class="reporte-linea">Comisión Total Ganada: <span id="reporte-comision-ganada">$0.00</span></div>
                <div class="reporte-linea">Comisión Ya Pagada: <span id="reporte-comision-pagada" style="color: red;">-$0.00</span></div>
            </div>
            <div class="total-comision">
                Comisión Pendiente de Pago:
                <div id="reporte-comision-pendiente">$0.00</div>
            </div>
            <button type="button" id="pagarComisionBtn">Pagar Comisión Pendiente</button>
        </div>
    </div>

    <script src="utils.js"></script>

    <script>
        // Selectores del DOM
        const form = document.getElementById('reporteForm');
        const mensajeDiv = document.getElementById('mensaje');
        const resultsDiv = document.getElementById('reporte-container');
        const uidInput = document.getElementById('uid');
        const pagarBtn = document.getElementById('pagarComisionBtn');
        
        // Selectores del modal ELIMINADOS
        
        // Objeto signaturePad ELIMINADO
        
        let currentUID = '';
        let currentNombre = '';
        let currentMontoPendiente = 0;

        // Función resizeCanvas ELIMINADA
        // Event listener de 'resize' ELIMINADO
        
        // --- SCRIPT (Web NFC) ---
        const scanBtn = document.getElementById('scanNFC');

        if ('NDEFReader' in window) {
            scanBtn.style.display = 'block'; 

            scanBtn.addEventListener('click', async () => {
                mensajeDiv.innerHTML = 'Acerca la tarjeta NFC al teléfono...';
                mensajeDiv.className = '';
                
                try {
                    const ndef = new NDEFReader();
                    await ndef.scan();

                    ndef.onreading = (event) => {
                        const serialNumber = event.serialNumber;
                        const uidHexDirecto = serialNumber.replace(/:/g, '').toUpperCase();
                        const uidFormatoUSB = convertirUid(uidHexDirecto); 
                        
                        uidInput.value = uidFormatoUSB; 
                        mensajeDiv.innerHTML = `<p class="exito">¡Tarjeta ${uidFormatoUSB} leída! Buscando...</p>`; 
                        
                        form.dispatchEvent(new Event('submit'));
                    };

                } catch (error) {
                    mensajeDiv.innerHTML = `<p class="error">Error de NFC: ${error.message}</p>`;
                }
            });
        }
        // --- Fin Script ---

        // FUNCIÓN PARA BUSCAR EL REPORTE
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            mensajeDiv.innerHTML = 'Buscando...';
            mensajeDiv.className = '';
            resultsDiv.style.display = 'none'; 
            pagarBtn.style.display = 'none';   
            
            const uid = uidInput.value.toUpperCase(); 
            
            if (!uid) {
                mensajeDiv.innerHTML = `<p class="error">Se requiere un UID.</p>`;
                return; 
            }
            
            currentUID = uid; 

            try {
                const response = await fetch(`/generar-reporte?uid=${uid}`);
                const data = await response.json();

                if (response.ok) {
                    mensajeDiv.innerHTML = ''; 
                    document.getElementById('reporte-nombre').innerText = data.nombre;
                    document.getElementById('reporte-pizzas').innerText = data.totalPizzasAsignadas;
                    document.getElementById('reporte-vendidas').innerText = data.totalPizzasVendidas;
                    document.getElementById('reporte-pagado').innerText = `$${data.totalVentaPagada}`;
                    document.getElementById('reporte-pendiente').innerText = `$${data.totalVentaPendiente}`;
                    document.getElementById('reporte-comision-ganada').innerText = `$${data.totalComisionesGanadas}`;
                    document.getElementById('reporte-comision-pagada').innerText = `-$${data.totalComisionesPagadas}`;
                    document.getElementById('reporte-comision-pendiente').innerText = `$${data.comisionPendienteAPagar}`;
                    currentNombre = data.nombre;
                    currentMontoPendiente = parseFloat(data.comisionPendienteAPagar);
                    resultsDiv.style.display = 'block';
                    if (currentMontoPendiente > 0) {
                        pagarBtn.style.display = 'block';
                    }

                    uidInput.value = '';
                    uidInput.focus();

                } else {
                    mensajeDiv.innerHTML = `<p class="error">${data.error}</p>`;
                }
            } catch (error) {
                mensajeDiv.innerHTML = `<p class="error">Error de conexión.</p>`;
            }
        });
        
        // --- ¡¡¡ LÓGICA DE PAGO SIMPLIFICADA !!! ---
        pagarBtn.addEventListener('click', async () => {
            
            // Confirmación simple
            if (!confirm(`¿Confirmas pagar $${currentMontoPendiente} a ${currentNombre}?`)) {
                return;
            }

            pagarBtn.disabled = true;
            pagarBtn.innerText = 'Procesando...';

            try {
                const response = await fetch('/pagar-comision', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: currentUID,
                        nombre: currentNombre,
                        montoPagado: currentMontoPendiente
                        // Ya no se envía el campo 'firma'
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    mensajeDiv.innerHTML = `<p class="exito">${data.mensaje}</p>`;
                    resultsDiv.style.display = 'none';
                    pagarBtn.style.display = 'none';
                    
                    // Refrescar el reporte
                    uidInput.value = currentUID; 
                    form.dispatchEvent(new Event('submit')); 
                } else {
                    alert(`Error: ${data.error}`);
                }

            } catch (error) {
                alert('Error de conexión al procesar el pago.');
            }

            pagarBtn.disabled = false;
            pagarBtn.innerText = 'Pagar Comisión Pendiente';
        });

        // Listeners del modal ELIMINADOS

    </script>
</body>
</html>